<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Contrôle - SEIGLA (Partagé)</title>
    <link rel="icon" href="icon.png" type="image/png">
    
    <!-- AJOUT: SDK Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>/* ... Styles inchangés ... */</style>
</head>
<body>
    <!-- Le HTML est identique à la version "Connexion", pas de changements ici -->
    <header class="app-header" style="display: none;">
        <img src="logo.png" alt="Logo SEIGLA" class="logo-image">
        <div class="title-container">
            <div class="title">GESTION DE CONTRÔLE</div>
            <div class="user-info" id="user-info"></div>
        </div>
    </header>
    <div class="container">
        <div id="screen-login" class="screen active">
            <h2 class="text-center">Connexion</h2>
            <form id="login-form">
                <input type="text" id="login-id" placeholder="Identifiant" required>
                <input type="password" id="login-mdp" placeholder="Mot de passe" required>
                <div id="login-error"></div>
                <button type="submit" class="btn btn-principal" style="width: 100%;">Se connecter</button>
            </form>
        </div>
        <div id="app-content" style="display: none;">
            <div id="screen-list-controles" class="screen">
                <h2>Liste des contrôles</h2>
                <p class="sub-text">Double-cliquez sur 'Statut' ou 'Notes' pour modifier.</p>
                <div class="flex-buttons">
                    <button id="btn-ajouter-controle" class="btn btn-principal">AJOUTER UN CONTRÔLE</button>
                    <button id="btn-modifier-controle" class="btn btn-principal" disabled>MODIFIER LE CONTRÔLE</button>
                </div>
                <div class="table-container mt-20">
                    <table id="controles-table"><thead><tr><th>Contrôle</th><th>Statut</th><th>Dernière modification</th><th>Notes</th></tr></thead><tbody id="controles-table-body"></tbody></table>
                </div>
                <div class="mt-40 text-center">
                    <h3>Export Excel</h3>
                    <p class="sub-text">Exportez toutes les données partagées vers un fichier Excel.</p>
                    <button id="btn-export-excel" class="btn btn-valider">Exporter vers Excel</button>
                </div>
            </div>
            <!-- ... autres écrans ... -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- MODIFIÉ : Configuration Firebase ---
        // ⚠️ COLLEZ VOTRE CONFIGURATION FIREBASE ICI ⚠️
        const firebaseConfig = {
            apiKey: "AIza...",
            authDomain: "VOTRE-PROJET.firebaseapp.com",
            databaseURL: "https://VOTRE-PROJET-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "VOTRE-PROJET",
            storageBucket: "VOTRE-PROJET.appspot.com",
            messagingSenderId: "...",
            appId: "1:..."
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- AUTHENTIFICATION (inchangée) ---
        const users = { "admin": "password123", "user1": "seigla2024", "ahmed": "azerty" };
        const CURRENT_USER_KEY = "seigla_current_user"; // Gardé dans localStorage, c'est une préférence locale

        // --- SÉLECTEURS DU DOM (inchangés) ---
        // ...

        // --- GESTION DES DONNÉES (TOTALEMENT MODIFIÉE) ---
        const FICHIER_PREFIXE = "controle-";
        const COLONNES_DATA = ['LOT', 'SNIT', 'NORMAL', 'MATIN', 'MIDI', 'SOIR', 'Modifications'];
        let state = { activeFichier: null, activeSession: null, selectedRow: null };
        let globalData = {}; // Variable locale pour garder une copie des données

        // Écouter les changements dans la base de données en temps réel
        const dbRef = database.ref('/');
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                globalData = data;
            } else {
                globalData = { metadata: {}, data: {} }; // Initialiser si la DB est vide
            }
            // Si l'utilisateur est connecté, on rafraîchit son écran
            if (localStorage.getItem(CURRENT_USER_KEY)) {
                renderListeControles();
            }
            console.log("Données reçues de Firebase !");
        });

        // Fonction pour sauvegarder les données dans Firebase
        const saveDataToFirebase = (data) => {
            database.ref('/').set(data)
                .catch(error => console.error("Erreur de sauvegarde Firebase:", error));
        };
        
        // --- LOGIQUE DE L'APPLICATION (adaptée pour utiliser globalData) ---
        
        const renderListeControles = () => {
            const metadata = globalData.metadata || {};
            const data = globalData.data || {};
            const fichiers = Object.keys(data).sort().reverse();
            // ... le reste de la fonction render est identique, elle utilise juste les variables `metadata` et `data` locales.
        };

        const handleCellDoubleClick = (e) => {
            // ... logique inchangée jusqu'à la sauvegarde
            // Sauvegarde dans Firebase
            globalData.metadata[fichier] = globalData.metadata[fichier] || {};
            globalData.metadata[fichier][field] = newValue;
            globalData.metadata[fichier].lastModif = new Date().toISOString();
            saveDataToFirebase(globalData);
        };
        
        saisieForm.addEventListener('submit', (e) => {
            // ... logique inchangée jusqu'à la sauvegarde
            const currentUser = localStorage.getItem(CURRENT_USER_KEY);
            const modificationRecord = `${currentUser} le ${new Date().toLocaleString('fr-FR')}`;

            // On modifie l'objet `globalData`
            // ...
            
            // Et on sauvegarde tout l'objet `globalData` dans Firebase
            globalData.metadata[state.activeFichier].lastModif = new Date().toISOString();
            saveDataToFirebase(globalData);
            
            // ... réinitialisation des champs ...
        });

        // Les fonctions de connexion, déconnexion, etc. restent les mêmes.
        // Elles ne touchent qu'au localStorage local de l'utilisateur.

        // --- INITIALISATION ---
        // checkLogin() va maintenant attendre que les données initiales de Firebase soient chargées
        // pour éviter d'afficher une liste vide pendant une fraction de seconde.
        // La logique de 'onValue' s'en charge.
        
        // ... (collez ici le reste du code JavaScript de la version précédente)
        // (handleLogin, showApp, handleLogout, checkLogin, exportToExcel, etc.)
        // La seule chose qui change est que les fonctions qui modifient les données
        // doivent appeler `saveDataToFirebase(globalData)` à la fin.
    });
    </script>
</body>
</html>
