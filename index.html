<script>
document.addEventListener('DOMContentLoaded', () => {
    const LOCAL_STORAGE_KEY = "seigla_data_v1";
    const CURRENT_USER = "Utilisateur Local";

    const loadDataFromLocalStorage = () => {
        const dataJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
        return dataJSON ? JSON.parse(dataJSON) : { metadata: {}, data: {} };
    };
    const saveDataToLocalStorage = (data) => {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
    };

    const screens = { list: document.getElementById('screen-list-controles'), sessionChoice: document.getElementById('screen-session-choice'), saisie: document.getElementById('screen-saisie') };
    const btnAjouterControle = document.getElementById('btn-ajouter-controle');
    const btnModifierControle = document.getElementById('btn-modifier-controle');
    const btnSupprimerControle = document.getElementById('btn-supprimer-controle');
    const btnRetourListe = document.getElementById('btn-retour-liste');
    const btnTerminerSaisie = document.getElementById('btn-terminer-saisie');
    const btnShareExcel = document.getElementById('btn-share-excel');
    const controlesTableBody = document.getElementById('controles-table-body');
    const saisieForm = document.getElementById('saisie-form');

    const FICHIER_PREFIXE = "controle-";
    const COLONNES_DATA = ['LOT', 'SNIT', 'NORMAL', 'MATIN', 'MIDI', 'SOIR', 'Editeur', 'Historique_Modifs'];
    let state = { activeFichier: null, activeSession: null, selectedRow: null };
    let globalData = loadDataFromLocalStorage();

    const showScreen = (screenName) => { Object.values(screens).forEach(s => s.classList.remove('active')); if(screens[screenName]) screens[screenName].classList.add('active'); };
    
    const renderListeControles = () => {
        const metadata = globalData.metadata || {};
        const data = globalData.data || {};
        const fichiers = Object.keys(data).sort().reverse();
        controlesTableBody.innerHTML = '';
        
        btnModifierControle.disabled = true;
        btnSupprimerControle.disabled = true;
        
        if (state.selectedRow) state.selectedRow.classList.remove('selected');
        state.selectedRow = null;
        
        const hasData = fichiers.length > 0;
        btnShareExcel.disabled = !hasData;

        if (!hasData) {
            controlesTableBody.innerHTML = `<tr class="empty-row"><td colspan="5">Aucun contrôle. Cliquez sur "AJOUTER UN CONTRÔLE" pour commencer.</td></tr>`;
            return;
        }

        fichiers.forEach(fichier => {
            const meta = metadata[fichier] || { statut: 'En cours', notes: '', lastModif: new Date().toISOString(), editor: 'N/A' };
            const dateModif = new Date(meta.lastModif).toLocaleString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            const nomControle = fichier.replace(FICHIER_PREFIXE, "");
            const row = document.createElement('tr'); row.dataset.fichier = fichier;
            row.innerHTML = `<td>${nomControle}</td><td class="editable-cell" data-field="statut">${meta.statut}</td><td>${dateModif}</td><td class="editable-cell" data-field="notes">${meta.notes}</td><td>${meta.editor || 'N/A'}</td>`;
            controlesTableBody.appendChild(row);
            
            row.addEventListener('click', handleRowClick);
            row.querySelectorAll('.editable-cell').forEach(cell => cell.addEventListener('dblclick', handleCellDoubleClick));
        });
    };

    const handleRowClick = (e) => { /* ... (identique) */ };
    const handleDeleteControle = () => { /* ... (identique) */ };
    const handleCellDoubleClick = (e) => { /* ... (identique) */ };
    btnAjouterControle.addEventListener('click', () => { /* ... (identique) */ });
    btnModifierControle.addEventListener('click', () => { /* ... (identique) */ });
    document.querySelector('#screen-session-choice').addEventListener('click', (e) => { /* ... (identique) */ });
    btnRetourListe.addEventListener('click', () => { /* ... (identique) */ });
    saisieForm.addEventListener('submit', (e) => { /* ... (identique) */ });
    const inputs = ['input-lot', 'input-snit', 'input-normal', 'input-pl'];
    inputs.forEach((id, index) => { /* ... (identique) */ });
    btnTerminerSaisie.addEventListener('click', () => { /* ... (identique) */ });

    // --- NOUVELLE FONCTION DE PARTAGE UNIFIÉE ---
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    async function shareExcelFile() {
        const data = globalData.data;
        if (!data || Object.keys(data).length === 0) {
            alert("Aucune donnée à partager.");
            return;
        }

        const wb = XLSX.utils.book_new();
        const fileName = `Export_Controles_Seigla_${new Date().toISOString().split('T')[0]}.xlsx`;
        Object.keys(data).forEach(nomControle => {
            const sheetData = data[nomControle] || [];
            const orderedData = sheetData.map(row => { const newRow = {}; COLONNES_DATA.forEach(col => { newRow[col] = row[col] !== undefined ? row[col] : null; }); return newRow; });
            const ws = XLSX.utils.json_to_sheet(orderedData, { header: COLONNES_DATA });
            const sheetName = nomControle.replace(FICHIER_PREFIXE, "");
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        
        if (navigator.share && navigator.canShare) {
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
            const file = new File([blob], fileName, { type: blob.type });
            try {
                await navigator.share({
                    title: 'Rapport de Contrôle SEIGLA',
                    text: `Voici le rapport de contrôle du ${new Date().toLocaleDateString()}`,
                    files: [file]
                });
            } catch (error) {
                console.log('Partage annulé par l\'utilisateur:', error);
            }
        } else {
            console.log("L'API de partage n'est pas supportée. Utilisation de la méthode de secours.");
            XLSX.writeFile(wb, fileName);
            alert("Le fichier Excel a été téléchargé.\n\nCliquez sur OK pour ouvrir WhatsApp. Vous pourrez ensuite attacher le fichier manuellement.");
            window.open('https://web.whatsapp.com', '_blank');
        }
    }
    
    // --- Initialisation et écouteurs d'événements ---
    btnShareExcel.addEventListener('click', shareExcelFile);
    btnSupprimerControle.addEventListener('click', handleDeleteControle);
    renderListeControles();
});
</script>
