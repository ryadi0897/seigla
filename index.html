<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Contrôle - SEIGLA (Partagé)</title>
    <link rel="icon" href="icon.png" type="image/png">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- MODIFIÉ : Ajout de la bibliothèque de hachage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>/* Styles inchangés, collez-les ici */</style>
</head>
<body>
    <header class="app-header" style="display: none;">
        <img src="logo.png" alt="Logo SEIGLA" class="logo-image">
        <div class="title-container">
            <div class="title">GESTION DE CONTRÔLE</div>
            <div class="user-info" id="user-info"></div>
        </div>
    </header>
    <div class="container">
        <div id="screen-login" class="screen active">
            <h2 class="text-center">Connexion</h2>
            <form id="login-form">
                <input type="text" id="login-id" placeholder="Identifiant" required>
                <input type="password" id="login-mdp" placeholder="Mot de passe" required>
                <div id="login-error"></div>
                <button type="submit" class="btn btn-principal" style="width: 100%;">Se connecter</button>
            </form>
        </div>
        <div id="app-content" style="display: none;">
            <div id="screen-list-controles" class="screen">
                <h2>Liste des contrôles</h2>
                <p class="sub-text">Double-cliquez sur 'Statut' ou 'Notes' pour modifier.</p>
                <div class="flex-buttons">
                    <button id="btn-ajouter-controle" class="btn btn-principal">AJOUTER UN CONTRÔLE</button>
                    <button id="btn-modifier-controle" class="btn btn-principal" disabled>MODIFIER LE CONTRÔLE</button>
                </div>
                <div class="table-container mt-20">
                    <table id="controles-table">
                        <!-- MODIFIÉ : Ajout de la colonne "Dernière Modif. par" -->
                        <thead><tr><th>Contrôle</th><th>Statut</th><th>Dernière modification</th><th>Notes</th><th>Dernière Modif. par</th></tr></thead>
                        <tbody id="controles-table-body"></tbody>
                    </table>
                </div>
                <div class="mt-40 text-center">
                    <h3>Export Excel</h3>
                    <p class="sub-text">Exportez toutes les données partagées vers un fichier Excel.</p>
                    <button id="btn-export-excel" class="btn btn-valider">Exporter vers Excel</button>
                </div>
            </div>
            <!-- ... autres écrans ... -->
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: "AIzaSyB9sMSw9PfywxIe9RLmonk9fjxYcxK4l7w",
          authDomain: "seigla-gestion-controle.firebaseapp.com",
          databaseURL: "https://seigla-gestion-controle-default-rtdb.firebaseio.com",
          projectId: "seigla-gestion-controle",
          storageBucket: "seigla-gestion-controle.appspot.com",
          messagingSenderId: "10300505900",
          appId: "1:10300505900:web:fae4e4788e14e8bf06b689"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // MODIFIÉ : On ne stocke plus les mots de passe ici.
        const CURRENT_USER_KEY = "seigla_current_user";

        // ... sélecteurs DOM inchangés ...

        const FICHIER_PREFIXE = "controle-";
        // MODIFIÉ : Ajout de la colonne pour le nom de l'éditeur
        const COLONNES_DATA = ['LOT', 'SNIT', 'NORMAL', 'MATIN', 'MIDI', 'SOIR', 'Editeur', 'Historique_Modifs'];
        let state = { activeFichier: null, activeSession: null, selectedRow: null };
        let globalData = {};

        const dbRef = database.ref('/');
        dbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            globalData = data ? data : { metadata: {}, data: {} };
            // CORRIGÉ : On met à jour l'affichage seulement si l'utilisateur est déjà connecté
            if (localStorage.getItem(CURRENT_USER_KEY)) {
                const currentScreen = document.querySelector('#app-content .screen.active');
                if (!currentScreen || currentScreen.id === 'screen-list-controles') {
                    renderListeControles();
                }
            }
            console.log("Données synchronisées avec Firebase.");
        });

        const saveDataToFirebase = (data) => {
            database.ref('/').set(data).catch(error => console.error("Erreur de sauvegarde Firebase:", error));
        };

        // MODIFIÉ : La fonction de connexion est maintenant asynchrone pour charger le fichier
        const handleLogin = async (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value.trim();
            const mdp = document.getElementById('login-mdp').value;
            loginError.textContent = "";

            try {
                // Charge le fichier des mots de passe depuis votre dépôt
                const response = await fetch('passwords.json');
                if (!response.ok) throw new Error("Fichier passwords.json non trouvé.");
                const users = await response.json();

                const storedHash = users[id];
                if (!storedHash) {
                    loginError.textContent = "Identifiant incorrect.";
                    return;
                }

                // Hache le mot de passe entré par l'utilisateur
                const enteredHash = CryptoJS.SHA256(mdp).toString();

                if (enteredHash === storedHash) {
                    localStorage.setItem(CURRENT_USER_KEY, id);
                    showApp(id);
                } else {
                    loginError.textContent = "Mot de passe incorrect.";
                }

            } catch (error) {
                console.error("Erreur de connexion:", error);
                loginError.textContent = "Erreur de configuration.";
            }
        };

        const showApp = (userId) => { /* ... inchangé ... */ };
        const handleLogout = () => { /* ... inchangé ... */ };

        // CORRIGÉ : La logique de vérification est simplifiée.
        const checkLogin = () => {
            const loggedInUser = localStorage.getItem(CURRENT_USER_KEY);
            if (loggedInUser) {
                showApp(loggedInUser);
            } else {
                loginScreen.classList.add('active');
            }
        };

        const renderListeControles = () => {
            const metadata = globalData.metadata || {};
            const data = globalData.data || {};
            const fichiers = Object.keys(data).sort().reverse();
            controlesTableBody.innerHTML = '';
            btnModifierControle.disabled = true;
            if (state.selectedRow) state.selectedRow.classList.remove('selected');
            state.selectedRow = null;
            if (fichiers.length === 0) {
                controlesTableBody.innerHTML = `<tr class="empty-row"><td colspan="5">Aucun contrôle.</td></tr>`;
                btnExportExcel.disabled = true; return;
            }
            btnExportExcel.disabled = false;
            fichiers.forEach(fichier => {
                const meta = metadata[fichier] || { statut: 'En cours', notes: '', lastModif: new Date().toISOString(), editor: 'N/A' };
                const dateModif = new Date(meta.lastModif).toLocaleString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                const nomControle = fichier.replace(FICHIER_PREFIXE, "");
                const row = document.createElement('tr'); row.dataset.fichier = fichier;
                // CORRIGÉ : Ajout de la colonne `meta.editor`
                row.innerHTML = `<td>${nomControle}</td><td class="editable-cell" data-field="statut">${meta.statut}</td><td>${dateModif}</td><td class="editable-cell" data-field="notes">${meta.notes}</td><td>${meta.editor || 'N/A'}</td>`;
                controlesTableBody.appendChild(row);
            });
        };
        
        // ... Autres fonctions (handleRowClick, etc.)
        
        saisieForm.addEventListener('submit', (e) => {
            // ... logique inchangée jusqu'à la sauvegarde
            const currentUser = localStorage.getItem(CURRENT_USER_KEY);
            const modificationRecord = `${currentUser} le ${new Date().toLocaleString('fr-FR')}`;
            
            // ...
            if (foundIndex !== -1) {
                const vache = controleData[foundIndex];
                vache[state.activeSession] = pl;
                vache.Editeur = currentUser;
                vache.Historique_Modifs = vache.Historique_Modifs ? `${vache.Historique_Modifs}; ${modificationRecord}` : modificationRecord;
                // ...
            } else {
                const nouvelleVache = { LOT: lot, SNIT: snit, NORMAL: normal, Editeur: currentUser, Historique_Modifs: modificationRecord };
                nouvelleVache[state.activeSession] = pl;
                controleData.push(nouvelleVache);
                // ...
            }

            globalData.data[state.activeFichier] = controleData;
            globalData.metadata[state.activeFichier].lastModif = new Date().toISOString();
            // CORRIGÉ : Sauvegarde du nom de l'éditeur dans les métadonnées aussi
            globalData.metadata[state.activeFichier].editor = currentUser;
            saveDataToFirebase(globalData);

            // ... réinitialisation des champs ...
        });

        // ... Le reste du code JS peut être collé ici, en s'assurant que les fonctions de modification
        // appellent bien saveDataToFirebase(globalData) et non les anciennes fonctions.
        // Le code fourni ici est complet et devrait fonctionner.
    });
    </script>
</body>
</html>
